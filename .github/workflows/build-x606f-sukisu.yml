name: Build Pissarro Kernel with SukiSU Ultra (4.14)  # æ˜ç¡®å†…æ ¸ç‰ˆæœ¬

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå·¥ä½œæµæ‰€åœ¨ä»“åº“ï¼‰
      - name: Checkout Current Repository
        uses: actions/checkout@v4

      # 2. å…‹éš†ç›®æ ‡å†…æ ¸æºç ä»“åº“ï¼ˆhttps://github.com/SYSTEM-winTX/000ï¼‰åˆ°kernel-sourceç›®å½•
      - name: Checkout Kernel Source from Target Repository
        uses: actions/checkout@v4
        with:
          repository: SYSTEM-winTX/000  # ä½ çš„å†…æ ¸æºç ä»“åº“
          path: kernel-source           # å…‹éš†åˆ°kernel-sourceç›®å½•
          ref: main                    # åˆ†æ”¯åï¼ˆæ ¹æ®å®é™…è°ƒæ•´ï¼Œå¦‚masterï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}  # è®¿é—®ä»¤ç‰Œï¼ˆå…¬å¼€ä»“åº“å¯çœç•¥ï¼‰

      # 3. è®¾ç½®æ„å»ºç¯å¢ƒï¼ˆå®‰è£…ä¾èµ–ï¼‰
      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make automake \
            autogen autoconf pkg-config git wget tar xz-utils gcc g++ \
            build-essential ccache curl python3 python3-pip unzip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu patch libelf-dev libncurses5-dev
          echo "âœ… Build environment ready"

      # 4. ã€æœ€ç»ˆä¿®æ­£ã€‘åº”ç”¨SukiSU_patchä»“åº“çš„4.14å†…æ ¸è¡¥ä¸ï¼ˆè·¯å¾„ï¼šä»“åº“æ ¹ç›®å½•/4.14/ksu_hooks_4.14.patchï¼‰
      - name: Apply SukiSU Patch (4.14 Kernel)
        run: |
          set -x  # å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºæ‰€æœ‰å‘½ä»¤åŠå‚æ•°ï¼ˆä¾¿äºæ’æŸ¥ï¼‰
          
          # --------------------------
          # 1. å¼ºåˆ¶å…‹éš†SukiSU_patchä»“åº“ï¼ˆç¡®ä¿æˆåŠŸï¼‰
          # --------------------------
          PATCH_REPO_URL="https://github.com/SukiSU-Ultra/SukiSU_patch.git"  # å®˜æ–¹åœ°å€
          PATCH_DIR="patches"  # å…‹éš†åˆ°å½“å‰ç›®å½•çš„patchesæ–‡ä»¶å¤¹
          echo "ğŸ” Cloning SukiSU_patch repo (ç›®æ ‡è·¯å¾„ï¼š$PATCH_DIR/4.14/ksu_hooks_4.14.patch)..."
          
          # æ­¥éª¤1ï¼šåˆ é™¤æ®‹ç•™çš„patchesç›®å½•ï¼ˆé¿å…æ—§æ–‡ä»¶å¹²æ‰°ï¼‰
          rm -rf "$PATCH_DIR"
          
          # æ­¥éª¤2ï¼šå…‹éš†ä»“åº“ï¼ˆä¼˜å…ˆå®˜æ–¹åœ°å€ï¼Œå¤±è´¥åˆ™ç”¨ä»£ç†ï¼‰
          if git clone --depth=1 "$PATCH_REPO_URL" "$PATCH_DIR"; then
            echo "âœ… å®˜æ–¹åœ°å€å…‹éš†æˆåŠŸ"
          else
            echo "âš ï¸ å®˜æ–¹åœ°å€å¤±è´¥ï¼Œå°è¯•ä»£ç†åœ°å€..."
            if git clone --depth=1 "https://ghproxy.com/$PATCH_REPO_URL" "$PATCH_DIR"; then
              echo "âœ… ä»£ç†åœ°å€å…‹éš†æˆåŠŸ"
            else
              echo "âŒ å…‹éš†å¤±è´¥ï¼è¯·æ‰‹åŠ¨æ£€æŸ¥ï¼š"
              echo "1. ä»“åº“æ˜¯å¦å­˜åœ¨ï¼šhttps://github.com/SukiSU-Ultra/SukiSU_patch"
              echo "2. ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®GitHubï¼ˆå¯å°è¯•åœ¨Actionsæ—¥å¿—ä¸­ping github.comï¼‰"
              exit 1
            fi
          fi

          # æ­¥éª¤3ï¼šéªŒè¯å…‹éš†ç»“æœï¼ˆå¿…é¡»å­˜åœ¨4.14ç›®å½•å’Œè¡¥ä¸æ–‡ä»¶ï¼‰
          if [ ! -d "$PATCH_DIR/4.14" ]; then
            echo "âŒ é”™è¯¯ï¼š$PATCH_DIR/4.14ç›®å½•ä¸å­˜åœ¨ï¼ä»“åº“ç»“æ„å¯èƒ½å·²å˜æ›´ã€‚"
            echo "ğŸ” ä»“åº“å®é™…ç»“æ„ï¼š"
            ls -la "$PATCH_DIR"  # åˆ—å‡ºå…‹éš†åçš„æ–‡ä»¶
            exit 1
          fi
          if [ ! -f "$PATCH_DIR/4.14/ksu_hooks_4.14.patch" ]; then
            echo "âŒ é”™è¯¯ï¼šè¡¥ä¸æ–‡ä»¶$PATCH_DIR/4.14/ksu_hooks_4.14.patchä¸å­˜åœ¨ï¼"
            echo "ğŸ” 4.14ç›®å½•å†…å®¹ï¼š"
            ls -la "$PATCH_DIR/4.14"  # åˆ—å‡º4.14ç›®å½•æ–‡ä»¶
            exit 1
          fi
          echo "âœ… ç¡®è®¤è¡¥ä¸æ–‡ä»¶å­˜åœ¨ï¼š$PATCH_DIR/4.14/ksu_hooks_4.14.patch"

          # --------------------------
          # 2. è¿›å…¥å†…æ ¸æºç ç›®å½•ï¼ˆkernel-sourceï¼‰
          # --------------------------
          cd kernel-source || { echo "âŒ é”™è¯¯ï¼škernel-sourceç›®å½•ä¸å­˜åœ¨ï¼"; exit 1; }
          echo "âœ… è¿›å…¥å†…æ ¸æºç ç›®å½•ï¼š$PWD"

          # --------------------------
          # 3. åº”ç”¨è¡¥ä¸ï¼ˆè·¯å¾„100%åŒ¹é…ä½ çš„æè¿°ï¼‰
          # --------------------------
          PATCH_PATH="../$PATCH_DIR/4.14/ksu_hooks_4.14.patch"  # ç›¸å¯¹è·¯å¾„ï¼šä»kernel-sourceåˆ°è¡¥ä¸æ–‡ä»¶
          echo "ğŸ”§ åº”ç”¨è¡¥ä¸ï¼š$PATCH_PATH"
          
          # åº”ç”¨è¡¥ä¸ï¼ˆä¼˜å…ˆç”¨git amï¼Œå¤±è´¥åˆ™ç”¨git apply --rejectï¼‰
          if git am "$PATCH_PATH"; then
            echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸï¼ˆgit amï¼‰"
          elif git apply "$PATCH_PATH"; then
            echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸï¼ˆgit applyï¼‰"
          else
            echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥ï¼ˆå¯èƒ½å­˜åœ¨å†²çªï¼‰ï¼Œç”Ÿæˆ.rejæ–‡ä»¶ä¾›åˆ†æ..."
            git apply --reject "$PATCH_PATH"  # ç”Ÿæˆ.rejæ–‡ä»¶æ˜¾ç¤ºå†²çªä½ç½®
            echo "âš ï¸ è¯·æŸ¥çœ‹å†…æ ¸æºç ç›®å½•ä¸­çš„*.rejæ–‡ä»¶ï¼Œæ‰‹åŠ¨è§£å†³å†²çªåé‡è¯•"
            # è‹¥éœ€å¼ºåˆ¶ç»§ç»­ç¼–è¯‘ï¼Œæ³¨é‡Šä¸‹ä¸€è¡Œï¼›å¦åˆ™å–æ¶ˆæ³¨é‡Šexit 1
            # exit 1
          fi
          echo "âœ… è¡¥ä¸å¤„ç†å®Œæˆ"

      # 5. è®¾ç½®å†…æ ¸æ ¹ç›®å½•ï¼ˆKDIRï¼‰ä¸ºç›®æ ‡ä»“åº“ï¼ˆkernel-sourceï¼‰
      - name: Set Kernel Root Directory (KDIR)
        id: set-kdir
        run: |
          KDIR="$GITHUB_WORKSPACE/kernel-source"  # å†…æ ¸æºç åœ¨kernel-sourceç›®å½•
          if [ ! -d "$KDIR/arch" ]; then
            echo "âŒ ERROR: $KDIR/arch not found! Ensure target repo has kernel source (arch/arm64)"
            exit 1
          fi
          echo "âœ… Kernel root directory (KDIR): $KDIR"
          echo "KDIR=$KDIR" >> $GITHUB_ENV  # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨

      # 6. æŸ¥æ‰¾pissarroè®¾å¤‡çš„defconfigï¼ˆçº¢ç±³Note 11 Proï¼‰
      - name: Detect Pissarro Defconfig
        id: detect-defconfig
        run: |
          cd $KDIR  # è¿›å…¥å†…æ ¸æºç ç›®å½•
          # ä¼˜å…ˆæŸ¥æ‰¾å«"pissarro"çš„defconfig
          DEFCONFIG=$(find arch/arm64/configs -type f -name "*pissarro*_defconfig" | head -n 1 | xargs basename)
          # æœªæ‰¾åˆ°åˆ™å°è¯•çº¢ç±³Note 11 Proå¸¸è§åç§°
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG=$(find arch/arm64/configs -type f \( -name "*umi*_defconfig" -o -name "*redmi*note*11*pro*_defconfig" \) | head -n 1 | xargs basename)
          fi
          # æ£€æŸ¥defconfigæ˜¯å¦å­˜åœ¨
          if [ -z "$DEFCONFIG" ] || [ ! -f "arch/arm64/configs/$DEFCONFIG" ]; then
            echo "âŒ ERROR: No valid defconfig found for pissarro!"
            echo "Available defconfigs in $KDIR/arch/arm64/configs/:"
            ls -la arch/arm64/configs/ | grep "_defconfig"
            exit 1
          fi
          echo "âœ… Found defconfig: $DEFCONFIG (for pissarro)"
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

      # 7. ç¼–è¯‘å†…æ ¸ï¼ˆARM64æ¶æ„ï¼Œäº¤å‰ç¼–è¯‘ï¼‰
      - name: Build Kernel (4.14)
        run: |
          cd $KDIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-  # äº¤å‰ç¼–è¯‘å™¨ï¼ˆå·²å®‰è£…ï¼‰
          
          # åŠ è½½defconfig
          echo "ğŸ”¨ Running make $DEFCONFIG"
          make $DEFCONFIG
          
          # ä¿®å¤æ¨¡å—ç¼–è¯‘é—®é¢˜ï¼ˆä¿ç•™åŸå§‹é€»è¾‘ï¼‰
          find drivers -name "modules.builtin" -exec rm {} \; || true
          find drivers -type d -exec touch {}/modules.builtin \; || true
          
          # å¹¶è¡Œç¼–è¯‘ï¼ˆ-j$(nproc)ï¼‰ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
          echo "ğŸ”¨ Building kernel with $(nproc) threads..."
          if ! make -j$(nproc); then
            echo "âš ï¸ Parallel build failed, retrying in single-thread mode"
            make
          fi
          echo "âœ… Kernel compiled successfully!"

      # 8. æå–å†…æ ¸é•œåƒï¼ˆImage.gz-dtbæˆ–Imageï¼‰
      - name: Extract Kernel Image
        run: |
          cd $KDIR
          OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          mkdir -p $OUTPUT_DIR
          
          # ä¼˜å…ˆæ‰¾GKIæ ¼å¼çš„Image.gz-dtbï¼Œå…¶æ¬¡æ‰¾Image
          if [ -f arch/arm64/boot/Image.gz-dtb ]; then
            cp arch/arm64/boot/Image.gz-dtb $OUTPUT_DIR/kernel.img
            echo "âœ… Found Image.gz-dtb (GKI format)"
          elif [ -f arch/arm64/boot/Image ]; then
            cp arch/arm64/boot/Image $OUTPUT_DIR/kernel.img
            echo "âœ… Found Image (non-GKI format)"
          else
            echo "âŒ ERROR: Kernel image not found in $KDIR/arch/arm64/boot/!"
            exit 1
          fi

      # 9. ã€èåˆAnyKernel3æ¨¡æ¿ã€‘ç”Ÿæˆåˆ·æœºåŒ…ï¼ˆä¼˜å…ˆä½¿ç”¨SukiSU_patchä»“åº“æ ¹ç›®å½•/AnyKernel3ï¼‰
      - name: Generate AnyKernel3 Flashable ZIP
        run: |
          # æ–¹æ¡ˆ1ï¼šä½¿ç”¨SukiSU_patchä»“åº“çš„AnyKernel3æ¨¡æ¿ï¼ˆä»“åº“æ ¹ç›®å½•/AnyKernel3ï¼‰
          # æ³¨ï¼špatchesç›®å½•æ˜¯å…‹éš†SukiSU_patchä»“åº“åçš„ç›®å½•ï¼Œæ•…è·¯å¾„ä¸º../patches/AnyKernel3
          PATCH_ANYKERNEL_DIR="../patches/AnyKernel3"
          if [ -d "$PATCH_ANYKERNEL_DIR" ]; then
            echo "âœ… ä½¿ç”¨SukiSU_patchä»“åº“çš„AnyKernel3æ¨¡æ¿ï¼ˆè·¯å¾„ï¼š$PATCH_ANYKERNEL_DIRï¼‰"
            cp -r "$PATCH_ANYKERNEL_DIR" anykernel3  # å¤åˆ¶åˆ°å·¥ä½œæµç›®å½•
          else
            # æ–¹æ¡ˆ2ï¼šè‹¥æ¨¡æ¿ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨å…‹éš†é»˜è®¤AnyKernel3ï¼ˆå¤‡ç”¨ï¼‰
            echo "âš ï¸ SukiSU_patchä»“åº“æœªæ‰¾åˆ°AnyKernel3æ¨¡æ¿ï¼Œå…‹éš†é»˜è®¤æ¨¡æ¿"
            git clone https://ghproxy.com/https://github.com/osm0sis/AnyKernel3.git anykernel3 --depth=1
          fi
          
          # å¤åˆ¶å†…æ ¸é•œåƒåˆ°AnyKernel3ç›®å½•
          cp $GITHUB_WORKSPACE/output/kernel.img anykernel3/
          
          # ä¿®æ”¹AnyKernel3è®¾å¤‡ä¿¡æ¯ï¼ˆé€‚é…pissarroï¼Œä½¿ç”¨SukiSU_patchæ¨¡æ¿æ—¶å¯ä¿ç•™å…¶é…ç½®ï¼Œæ­¤å¤„ç»Ÿä¸€è¦†ç›–ï¼‰
          cat > anykernel3/anykernel.sh << 'EOF'
          # AnyKernel3 for Pissarro (Redmi Note 11 Pro) - SukiSU Ultra 4.14
          kernel.string=SukiSU Ultra 4.14 for Pissarro
          kernel.version=SukiSU-Ultra-4.14-$(date +%Y%m%d)
          device.name1=pissarro
          device.name2=21091116C
          device.name3=Redmi Note 11 Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          block=/dev/block/bootdevice/by-name/boot
          supported.versions=13-15  # æ”¯æŒAndroid 13-15
          EOF
          
          # æ‰“åŒ…ä¸ºåˆ·æœºZIP
          cd anykernel3
          zip -r9 ../SukiSU-Ultra-4.14-pissarro-anykernel3.zip ./* -x ".git/*" "README.md" "LICENSE"
          cd ..
          echo "âœ… ç”ŸæˆAnyKernel3åˆ·æœºåŒ…ï¼šSukiSU-Ultra-4.14-pissarro-anykernel3.zip"

      # 10. ä¸Šä¼ æœ€ç»ˆåˆ·æœºåŒ…ï¼ˆä¾›ä¸‹è½½ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-4.14-pissarro-anykernel3  # äº§ç‰©åå«å†…æ ¸ç‰ˆæœ¬
          path: SukiSU-Ultra-4.14-pissarro-anykernel3.zip  # åˆ·æœºåŒ…è·¯å¾„
