name: Build Pissarro Kernel with SukiSU Ultra  # é‡å‘½åå·¥ä½œæµï¼Œæ˜ç¡®è®¾å¤‡

on:
  workflow_dispatch:  # ä¿ç•™æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4  # æ£€å‡ºä½ çš„Forkä»“åº“

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make automake \
            autogen autoconf pkg-config git wget tar xz-utils gcc g++ \
            build-essential ccache curl python3 python3-pip unzip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu patch  # æ–°å¢patchå·¥å…·ï¼ˆç”¨äºæ‰“è¡¥ä¸ï¼‰
          echo "âœ… Build environment ready"

      # å…³é”®ä¿®æ”¹1ï¼šå…‹éš†pissarroå†…æ ¸æºç ï¼ˆæ›¿æ¢åŸå§‹"Extract Kernel Source"æ­¥éª¤ï¼‰
      - name: Clone Pissarro Kernel Source
        run: |
          # å…‹éš†pissarroå†…æ ¸æºç ï¼ˆå°ç±³å®˜æ–¹ä»“åº“ï¼Œè‹¥å¤±æ•ˆå¯æ›¿æ¢ä¸ºLineageOSç­‰ç¤¾åŒºä»“åº“ï¼‰
          git clone https://github.com/MiCode/kernel_xiaomi_pissarro.git kernel --depth=1
          # è‹¥å®˜æ–¹ä»“åº“ä¸å­˜åœ¨ï¼Œç”¨ç¤¾åŒºç»´æŠ¤çš„LineageOSä»“åº“ï¼ˆå–æ¶ˆä¸‹è¡Œæ³¨é‡Šå¹¶æ›¿æ¢ä¸Šä¸€è¡Œï¼‰
          # git clone https://github.com/LineageOS/android_kernel_xiaomi_pissarro.git kernel --depth=1
          echo "âœ… Cloned pissarro kernel source to kernel/"

      # å…³é”®ä¿®æ”¹2ï¼šåº”ç”¨SukiSU Ultraè¡¥ä¸ï¼ˆåŸå§‹å·¥ä½œæµæ— æ­¤æ­¥éª¤ï¼Œå¿…é¡»æ·»åŠ ï¼‰
      - name: Apply SukiSU Ultra Patches
        run: |
          # å…‹éš†SukiSU Ultraè¡¥ä¸ä»“åº“
          git clone https://github.com/SukiSU/SukiSU-Ultra-Patches.git patches --depth=1
          # è¿›å…¥å†…æ ¸ç›®å½•ï¼Œåº”ç”¨è¡¥ä¸ï¼ˆå‡è®¾è¡¥ä¸æ–‡ä»¶ä¸ºsukisu-ultra.patchï¼Œè‹¥æ–‡ä»¶åä¸åŒéœ€è°ƒæ•´ï¼‰
          cd kernel
          if [ -f ../patches/sukisu-ultra.patch ]; then
            git apply ../patches/sukisu-ultra.patch
            echo "âœ… Applied SukiSU Ultra patch"
          else
            echo "âš ï¸ Warning: sukisu-ultra.patch not found, skipping patch (may cause build failure)"
          fi
          cd ..

      # å…³é”®ä¿®æ”¹3ï¼šæŒ‡å®špissarroçš„KDIRå’Œdefconfigï¼ˆæ›¿æ¢åŸå§‹"Detect KDIR/defconfig"æ­¥éª¤ï¼‰
      - name: Set Pissarro Config
        id: set-config
        run: |
          # å†…æ ¸ç›®å½•ï¼ˆå·²å…‹éš†åˆ°kernel/ï¼‰
          KDIR="kernel"
          # pissarroçš„defconfigï¼ˆå¿…é¡»å­˜åœ¨äºkernel/arch/arm64/configs/ä¸‹ï¼Œè‹¥åç§°ä¸åŒéœ€ä¿®æ”¹ï¼‰
          DEFCONFIG="pissarro_defconfig"
          
          # æ£€æŸ¥defconfigæ˜¯å¦å­˜åœ¨
          if [ ! -f "$KDIR/arch/arm64/configs/$DEFCONFIG" ]; then
            echo "âŒ ERROR: $DEFCONFIG not found in $KDIR/arch/arm64/configs/"
            echo "Available defconfigs:"
            ls -la "$KDIR/arch/arm64/configs/" | grep "_defconfig"
            exit 1
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "KDIR=$KDIR" >> $GITHUB_ENV
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV
          echo "âœ… Set KDIR=$KDIR, DEFCONFIG=$DEFCONFIG"

      - name: Build Kernel
        run: |
          cd "$KDIR"
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-  # äº¤å‰ç¼–è¯‘å™¨ï¼ˆå·²é€šè¿‡aptå®‰è£…ï¼‰
          
          # åŠ è½½defconfig
          echo "ğŸ”¨ Running make $DEFCONFIG"
          make "$DEFCONFIG"
          
          # ä¿®å¤å¯èƒ½çš„æ¨¡å—é—®é¢˜ï¼ˆä¿ç•™åŸå§‹é€»è¾‘ï¼‰
          find drivers -name "modules.builtin" -exec rm {} \; || true
          find drivers -type d -exec touch {}/modules.builtin \; || true
          
          # ç¼–è¯‘å†…æ ¸ï¼ˆ-j$(nproc)å¹¶è¡Œç¼–è¯‘ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•ï¼‰
          echo "ğŸ”¨ Starting build with $(nproc) threads"
          if ! make -j$(nproc); then
            echo "âš ï¸ Parallel build failed, retrying in single-thread mode"
            make
          fi
          echo "âœ… Kernel built successfully"

      - name: Package Kernel Image
        run: |
          cd "$KDIR"
          OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          mkdir -p "$OUTPUT_DIR"
          
          # ä¼˜å…ˆæ‰¾Image.gz-dtbï¼ˆGKIå†…æ ¸å¸¸ç”¨ï¼‰ï¼Œå…¶æ¬¡æ‰¾Image
          if [ -f arch/arm64/boot/Image.gz-dtb ]; then
            cp arch/arm64/boot/Image.gz-dtb "$OUTPUT_DIR/kernel.img"  # é‡å‘½åä¸ºkernel.imgï¼ˆAnyKernel3é€šç”¨åï¼‰
          elif [ -f arch/arm64/boot/Image ]; then
            cp arch/arm64/boot/Image "$OUTPUT_DIR/kernel.img"
          else
            echo "âŒ ERROR: Kernel image (Image.gz-dtb/Image) not found in $KDIR/arch/arm64/boot/"
            exit 1
          fi
          echo "âœ… Kernel image copied to $OUTPUT_DIR/kernel.img"

      # å…³é”®ä¿®æ”¹4ï¼šç”ŸæˆAnyKernel3åˆ·æœºåŒ…ï¼ˆåŸå§‹ä»…æ‰“åŒ…é•œåƒï¼Œéœ€è¡¥å……AnyKernel3ç»“æ„ï¼‰
      - name: Generate AnyKernel3 Flashable Zip
        run: |
          # å…‹éš†AnyKernel3æ¨¡æ¿ï¼ˆç”¨äºæ‰“åŒ…åˆ·æœºåŒ…ï¼‰
          git clone https://github.com/osm0sis/AnyKernel3.git anykernel3 --depth=1
          
          # å¤åˆ¶å†…æ ¸é•œåƒåˆ°AnyKernel3ç›®å½•
          cp output/kernel.img anykernel3/
          
          # ä¿®æ”¹AnyKernel3è®¾å¤‡ä¿¡æ¯ï¼ˆé€‚é…pissarroï¼‰
          cat > anykernel3/anykernel.sh << 'EOF'
          # AnyKernel3 by osm0sis @ xda-developers
          kernel.string=SukiSU Ultra for Pissarro
          kernel.version=SukiSU-Ultra-$(date +%Y%m%d)
          device.name1=pissarro
          device.name2=21091116C
          device.name3=Redmi Note 11 Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          do.cleanuponabort=0
          device.name1=pissarro
          block=/dev/block/bootdevice/by-name/boot
          EOF
          
          # æ‰“åŒ…ä¸ºåˆ·æœºZIP
          cd anykernel3
          zip -r9 ../SukiSU-Ultra-pissarro-anykernel3.zip ./* -x ".git/*"  # æ’é™¤gitæ–‡ä»¶
          cd ..
          echo "âœ… Generated AnyKernel3 zip: SukiSU-Ultra-pissarro-anykernel3.zip"

      # å…³é”®ä¿®æ”¹5ï¼šä¸Šä¼ æœ€ç»ˆåˆ·æœºåŒ…ï¼ˆæ›¿æ¢åŸå§‹"Upload Artifact"ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-pissarro-anykernel3  # äº§ç‰©åå«è®¾å¤‡ä»£å·ï¼Œæ–¹ä¾¿è¯†åˆ«
          path: SukiSU-Ultra-pissarro-anykernel3.zip  # ä¸Šä¼ åˆ·æœºåŒ…ZIP
