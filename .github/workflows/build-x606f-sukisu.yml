name: Build Pissarro Kernel with SukiSU Ultra  # æ˜ç¡®è®¾å¤‡åç§°

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4  # æ£€å‡ºä½ çš„ä»“åº“ï¼ˆå«æ ¹ç›®å½•ä¸‹çš„archã€Makefileç­‰ï¼‰

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make automake \
            autogen autoconf pkg-config git wget tar xz-utils gcc g++ \
            build-essential ccache curl python3 python3-pip unzip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu patch libelf-dev libncurses5-dev
          echo "âœ… Build environment ready"

      # ã€å…³é”®ã€‘åˆ é™¤åŸ"Clone Pissarro Kernel Source"æ­¥éª¤ï¼ˆæºç å·²æ‰‹åŠ¨ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•ï¼‰
      # ã€å…³é”®ã€‘ç›´æ¥åº”ç”¨SukiSU Ultraè¡¥ä¸åˆ°ä»“åº“æ ¹ç›®å½•ï¼ˆå†…æ ¸æºç æ ¹ç›®å½•ï¼‰
      - name: Apply SukiSU Ultra Patches
        run: |
          # å…‹éš†SukiSU Ultraè¡¥ä¸ä»“åº“ï¼ˆè‹¥ç½‘ç»œä¸ä½³ï¼Œå¯æ›¿æ¢ä¸ºå›½å†…é•œåƒï¼‰
          git clone https://ghproxy.com/https://github.com/SukiSU/SukiSU-Ultra-Patches.git patches --depth=1
          # è¿›å…¥å†…æ ¸æ ¹ç›®å½•ï¼ˆä»“åº“æ ¹ç›®å½•ï¼Œå«arch/ï¼‰ï¼Œåº”ç”¨è¡¥ä¸
          cd $GITHUB_WORKSPACE  # åˆ‡æ¢åˆ°ä»“åº“æ ¹ç›®å½•ï¼ˆä½ çš„æºç åœ¨è¿™é‡Œï¼‰
          if [ -f patches/sukisu-ultra.patch ]; then
            git apply patches/sukisu-ultra.patch
            echo "âœ… Applied SukiSU Ultra patch to root source"
          else
            echo "âš ï¸ Warning: sukisu-ultra.patch not found, skipping patch"
          fi

      # ã€å…³é”®ã€‘è®¾ç½®å†…æ ¸æ ¹ç›®å½•ï¼ˆKDIRï¼‰ä¸ºä»“åº“æ ¹ç›®å½•ï¼ˆ$GITHUB_WORKSPACEï¼‰
      - name: Set Kernel Root Directory (KDIR)
        id: set-kdir
        run: |
          # å†…æ ¸æ ¹ç›®å½• = ä»“åº“æ ¹ç›®å½•ï¼ˆå«arch/ã€Makefileçš„é‚£ä¸ªç›®å½•ï¼‰
          KDIR="$GITHUB_WORKSPACE"
          echo "âœ… Kernel root directory (KDIR): $KDIR"
          echo "KDIR=$KDIR" >> $GITHUB_ENV  # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨

      # ã€å…³é”®ã€‘æŸ¥æ‰¾pissarroè®¾å¤‡çš„defconfigï¼ˆåœ¨KDIR/arch/arm64/configs/ä¸‹ï¼‰
      - name: Detect Pissarro Defconfig
        id: detect-defconfig
        run: |
          cd $KDIR  # è¿›å…¥å†…æ ¸æ ¹ç›®å½•
          # ä¼˜å…ˆæŸ¥æ‰¾å«"pissarro"çš„defconfigï¼ˆä½ çš„è®¾å¤‡ä»£å·ï¼‰
          DEFCONFIG=$(find arch/arm64/configs -type f -name "*pissarro*_defconfig" | head -n 1 | xargs basename)
          # è‹¥æœªæ‰¾åˆ°ï¼Œå°è¯•çº¢ç±³Note 11 Proçš„å¸¸è§åç§°ï¼ˆå¦‚"umi"æ˜¯æ—§ä»£å·ï¼Œ"redmi_note_11_pro"æ˜¯æ–°åç§°ï¼‰
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG=$(find arch/arm64/configs -type f \( -name "*umi*_defconfig" -o -name "*redmi*note*11*pro*_defconfig" \) | head -n 1 | xargs basename)
          fi
          # æœ€ç»ˆæ£€æŸ¥defconfigæ˜¯å¦å­˜åœ¨
          if [ -z "$DEFCONFIG" ] || [ ! -f "arch/arm64/configs/$DEFCONFIG" ]; then
            echo "âŒ ERROR: No valid defconfig found for pissarro!"
            echo "Available defconfigs in arch/arm64/configs/:"
            ls -la arch/arm64/configs/ | grep "_defconfig"  # åˆ—å‡ºæ‰€æœ‰å¯ç”¨defconfigï¼Œä¾›ä½ æ‰‹åŠ¨é€‰æ‹©
            exit 1
          fi
          echo "âœ… Found defconfig: $DEFCONFIG (for pissarro)"
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV  # å¯¼å‡ºdefconfigåç§°

      # ç¼–è¯‘å†…æ ¸ï¼ˆä½¿ç”¨æ­£ç¡®çš„KDIRå’Œdefconfigï¼‰
      - name: Build Kernel
        run: |
          cd $KDIR  # è¿›å…¥å†…æ ¸æ ¹ç›®å½•
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-  # äº¤å‰ç¼–è¯‘å™¨ï¼ˆå·²å®‰è£…ï¼‰
          
          # åŠ è½½pissarroçš„defconfig
          echo "ğŸ”¨ Running make $DEFCONFIG"
          make $DEFCONFIG
          
          # ä¿®å¤å¯èƒ½çš„æ¨¡å—ç¼–è¯‘é—®é¢˜ï¼ˆä¿ç•™åŸå§‹é€»è¾‘ï¼‰
          find drivers -name "modules.builtin" -exec rm {} \; || true
          find drivers -type d -exec touch {}/modules.builtin \; || true
          
          # å¹¶è¡Œç¼–è¯‘ï¼ˆ-j$(nproc)ï¼‰ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
          echo "ğŸ”¨ Building kernel with $(nproc) threads..."
          if ! make -j$(nproc); then
            echo "âš ï¸ Parallel build failed, retrying in single-thread mode"
            make
          fi
          echo "âœ… Kernel compiled successfully!"

      # æå–å†…æ ¸é•œåƒï¼ˆImage.gz-dtbæˆ–Imageï¼‰
      - name: Extract Kernel Image
        run: |
          cd $KDIR
          OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          mkdir -p $OUTPUT_DIR
          
          # ä¼˜å…ˆæ‰¾GKIæ ¼å¼çš„Image.gz-dtbï¼ˆæ¨èï¼‰ï¼Œå…¶æ¬¡æ‰¾Image
          if [ -f arch/arm64/boot/Image.gz-dtb ]; then
            cp arch/arm64/boot/Image.gz-dtb $OUTPUT_DIR/kernel.img
            echo "âœ… Found Image.gz-dtb (GKI format)"
          elif [ -f arch/arm64/boot/Image ]; then
            cp arch/arm64/boot/Image $OUTPUT_DIR/kernel.img
            echo "âœ… Found Image (non-GKI format)"
          else
            echo "âŒ ERROR: Kernel image not found! Check arch/arm64/boot/"
            exit 1
          fi

      # ç”ŸæˆAnyKernel3åˆ·æœºåŒ…ï¼ˆç›´æ¥åˆ·å…¥bootåˆ†åŒºï¼‰
      - name: Generate AnyKernel3 Flashable ZIP
        run: |
          # å…‹éš†AnyKernel3æ¨¡æ¿ï¼ˆè½»é‡ç‰ˆï¼Œä»…å«åˆ·å†™è„šæœ¬ï¼‰
          git clone https://ghproxy.com/https://github.com/osm0sis/AnyKernel3.git anykernel3 --depth=1
          
          # å¤åˆ¶å†…æ ¸é•œåƒåˆ°AnyKernel3ç›®å½•
          cp $GITHUB_WORKSPACE/output/kernel.img anykernel3/
          
          # ä¿®æ”¹AnyKernel3è®¾å¤‡ä¿¡æ¯ï¼ˆé€‚é…pissarroï¼‰
          cat > anykernel3/anykernel.sh << 'EOF'
          # AnyKernel3 for Pissarro (Redmi Note 11 Pro)
          kernel.string=SukiSU Ultra for Pissarro
          kernel.version=SukiSU-Ultra-$(date +%Y%m%d)
          device.name1=pissarro
          device.name2=21091116C
          device.name3=Redmi Note 11 Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          block=/dev/block/bootdevice/by-name/boot
          supported.versions=13-15  # æ”¯æŒAndroid 13-15
          EOF
          
          # æ‰“åŒ…ä¸ºåˆ·æœºZIPï¼ˆå«è®¾å¤‡ä¿¡æ¯å’Œåˆ·å†™è„šæœ¬ï¼‰
          cd anykernel3
          zip -r9 ../SukiSU-Ultra-pissarro-anykernel3.zip ./* -x ".git/*" "README.md"
          cd ..
          echo "âœ… Generated AnyKernel3 ZIP: SukiSU-Ultra-pissarro-anykernel3.zip"

      # ä¸Šä¼ æœ€ç»ˆåˆ·æœºåŒ…ï¼ˆä¾›ä¸‹è½½ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-pissarro-anykernel3  # äº§ç‰©åå«è®¾å¤‡ä»£å·
          path: SukiSU-Ultra-pissarro-anykernel3.zip  # åˆ·æœºåŒ…è·¯å¾„
