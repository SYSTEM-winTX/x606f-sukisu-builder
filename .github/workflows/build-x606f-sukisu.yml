name: Build Pissarro Kernel with SukiSU Ultra (4.14)  # æ˜ç¡®å†…æ ¸ç‰ˆæœ¬

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå·¥ä½œæµæ‰€åœ¨ä»“åº“ï¼‰
      - name: Checkout Current Repository
        uses: actions/checkout@v4

      # 2. å…‹éš†ç›®æ ‡å†…æ ¸æºç ä»“åº“ï¼ˆhttps://github.com/SYSTEM-winTX/000ï¼‰åˆ°kernel-sourceç›®å½•
      - name: Checkout Kernel Source from Target Repository
        uses: actions/checkout@v4
        with:
          repository: SYSTEM-winTX/000  # ä½ çš„å†…æ ¸æºç ä»“åº“
          path: kernel-source           # å…‹éš†åˆ°kernel-sourceç›®å½•
          ref: main                    # åˆ†æ”¯åï¼ˆæ ¹æ®å®é™…è°ƒæ•´ï¼Œå¦‚masterï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}  # è®¿é—®ä»¤ç‰Œï¼ˆå…¬å¼€ä»“åº“å¯çœç•¥ï¼‰

      # 3. è®¾ç½®æ„å»ºç¯å¢ƒï¼ˆå®‰è£…ä¾èµ–ï¼‰
      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make automake \
            autogen autoconf pkg-config git wget tar xz-utils gcc g++ \
            build-essential ccache curl python3 python3-pip unzip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu patch libelf-dev libncurses5-dev
          echo "âœ… Build environment ready"

      # 4. ã€æ ¸å¿ƒã€‘åº”ç”¨SukiSU_patchä»“åº“çš„4.14å†…æ ¸è¡¥ä¸ï¼ˆä»https://github.com/SukiSU-Ultra/SukiSU_patchå…‹éš†ï¼‰
      - name: Apply SukiSU Patch (4.14 Kernel)
  run: |
    set -x  # å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºæ‰€æœ‰å‘½ä»¤åŠå‚æ•°ï¼ˆä¾¿äºæ’æŸ¥ï¼‰
    
    # 1. å…‹éš†SukiSU_patchä»“åº“ï¼ˆå«4.14å†…æ ¸è¡¥ä¸ï¼‰
    PATCH_REPO_URL="https://github.com/SukiSU-Ultra/SukiSU_patch.git"
    PATCH_DIR="patches"  # å…‹éš†åˆ°patchesç›®å½•
    echo "ğŸ” Cloning SukiSU_patch repo: $PATCH_REPO_URL"
    git clone "$PATCH_REPO_URL" "$PATCH_DIR" --depth=1
    if [ $? -ne 0 ]; then
      echo "âŒ ERROR: Failed to clone SukiSU_patch repo. Check URL/network."
      exit 1
    fi
    echo "âœ… SukiSU_patch repo cloned to $PWD/$PATCH_DIR"

    # 2. è¿›å…¥å†…æ ¸æºç ç›®å½•ï¼ˆkernel-sourceï¼Œä½ çš„ç›®æ ‡ä»“åº“ï¼‰
    cd kernel-source || { echo "âŒ ERROR: kernel-source directory not found!"; exit 1; }
    echo "âœ… Entered kernel source directory: $PWD"

    # --------------------------
    # ã€å…³é”®ä¿®æ­£ã€‘4.14å†…æ ¸è¡¥ä¸è·¯å¾„ï¼ˆæ ¹æ®ä»“åº“ç»“æ„ï¼š4.14/sukisu-ultra-4.14.patchï¼‰
    # --------------------------
    PATCH_FILE="4.14/sukisu-ultra-4.14.patch"  # å®é™…è·¯å¾„ï¼šä»“åº“çš„4.14å­ç›®å½•ä¸‹çš„è¡¥ä¸æ–‡ä»¶
    PATCH_PATH="../$PATCH_DIR/$PATCH_FILE"  # ç›¸å¯¹è·¯å¾„ï¼šä»kernel-sourceåˆ°è¡¥ä¸æ–‡ä»¶ï¼ˆ../patches/4.14/sukisu-ultra-4.14.patchï¼‰
    echo "ğŸ” Target patch path: $PATCH_PATH"

    # 3. æ£€æŸ¥è¡¥ä¸æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥è·¯å¾„é”™è¯¯ï¼Œåˆ—å‡ºç›®å½•ä¾›è°ƒè¯•ï¼‰
    if [ ! -f "$PATCH_PATH" ]; then
      echo "âŒ ERROR: Patch file not found at $PATCH_PATH"
      echo "ğŸ” Available files in $PATCH_DIR/:"
      ls -la "$PATCH_DIR"  # åˆ—å‡ºè¡¥ä¸ä»“åº“æ ¹ç›®å½•æ–‡ä»¶ï¼ˆåº”æœ‰4.14/ç›®å½•ï¼‰
      echo "ğŸ” Available files in $PATCH_DIR/4.14/:"
      ls -la "$PATCH_DIR/4.14/"  # åˆ—å‡º4.14ç›®å½•ï¼ˆç¡®è®¤sukisu-ultra-4.14.patchå­˜åœ¨ï¼‰
      exit 1
    fi
    echo "âœ… Found 4.14 kernel patch: $PATCH_PATH"

    # 4. åº”ç”¨è¡¥ä¸ï¼ˆä¼˜å…ˆç”¨git amï¼Œå¤±è´¥åˆ™ç”¨git apply --rejectï¼‰
    echo "ğŸ”§ Applying 4.14 kernel patch..."
    if git am "$PATCH_PATH"; then
      echo "âœ… Patch applied successfully with git am"
    elif git apply "$PATCH_PATH"; then
      echo "âœ… Patch applied successfully with git apply"
    else
      echo "âš ï¸ Patch application failed (å¯èƒ½å­˜åœ¨å†²çª). Generating .rej file for analysis..."
      git apply --reject "$PATCH_PATH"  # ç”Ÿæˆ.rejæ–‡ä»¶æ˜¾ç¤ºå†²çªéƒ¨åˆ†
      echo "âš ï¸ Check *.rej files in kernel-source/ for manual conflict resolution"
      # è‹¥éœ€ä¸¥æ ¼åº”ç”¨è¡¥ä¸ï¼Œå–æ¶ˆä¸‹ä¸€è¡Œæ³¨é‡Šï¼šexit 1ï¼›å¦åˆ™ç»§ç»­ç¼–è¯‘
      # exit 1
    fi
    echo "âœ… Patch processing completed"

      # 5. è®¾ç½®å†…æ ¸æ ¹ç›®å½•ï¼ˆKDIRï¼‰ä¸ºç›®æ ‡ä»“åº“ï¼ˆkernel-sourceï¼‰
      - name: Set Kernel Root Directory (KDIR)
        id: set-kdir
        run: |
          KDIR="$GITHUB_WORKSPACE/kernel-source"  # å†…æ ¸æºç åœ¨kernel-sourceç›®å½•
          if [ ! -d "$KDIR/arch" ]; then
            echo "âŒ ERROR: $KDIR/arch not found! Ensure target repo has kernel source (arch/arm64)"
            exit 1
          fi
          echo "âœ… Kernel root directory (KDIR): $KDIR"
          echo "KDIR=$KDIR" >> $GITHUB_ENV  # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨

      # 6. æŸ¥æ‰¾pissarroè®¾å¤‡çš„defconfigï¼ˆçº¢ç±³Note 11 Proï¼‰
      - name: Detect Pissarro Defconfig
        id: detect-defconfig
        run: |
          cd $KDIR  # è¿›å…¥å†…æ ¸æºç ç›®å½•
          # ä¼˜å…ˆæŸ¥æ‰¾å«"pissarro"çš„defconfig
          DEFCONFIG=$(find arch/arm64/configs -type f -name "*pissarro*_defconfig" | head -n 1 | xargs basename)
          # æœªæ‰¾åˆ°åˆ™å°è¯•çº¢ç±³Note 11 Proå¸¸è§åç§°
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG=$(find arch/arm64/configs -type f \( -name "*umi*_defconfig" -o -name "*redmi*note*11*pro*_defconfig" \) | head -n 1 | xargs basename)
          fi
          # æ£€æŸ¥defconfigæ˜¯å¦å­˜åœ¨
          if [ -z "$DEFCONFIG" ] || [ ! -f "arch/arm64/configs/$DEFCONFIG" ]; then
            echo "âŒ ERROR: No valid defconfig found for pissarro!"
            echo "Available defconfigs in $KDIR/arch/arm64/configs/:"
            ls -la arch/arm64/configs/ | grep "_defconfig"
            exit 1
          fi
          echo "âœ… Found defconfig: $DEFCONFIG (for pissarro)"
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

      # 7. ç¼–è¯‘å†…æ ¸ï¼ˆARM64æ¶æ„ï¼Œäº¤å‰ç¼–è¯‘ï¼‰
      - name: Build Kernel (4.14)
        run: |
          cd $KDIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-  # äº¤å‰ç¼–è¯‘å™¨ï¼ˆå·²å®‰è£…ï¼‰
          
          # åŠ è½½defconfig
          echo "ğŸ”¨ Running make $DEFCONFIG"
          make $DEFCONFIG
          
          # ä¿®å¤æ¨¡å—ç¼–è¯‘é—®é¢˜ï¼ˆä¿ç•™åŸå§‹é€»è¾‘ï¼‰
          find drivers -name "modules.builtin" -exec rm {} \; || true
          find drivers -type d -exec touch {}/modules.builtin \; || true
          
          # å¹¶è¡Œç¼–è¯‘ï¼ˆ-j$(nproc)ï¼‰ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
          echo "ğŸ”¨ Building kernel with $(nproc) threads..."
          if ! make -j$(nproc); then
            echo "âš ï¸ Parallel build failed, retrying in single-thread mode"
            make
          fi
          echo "âœ… Kernel compiled successfully!"

      # 8. æå–å†…æ ¸é•œåƒï¼ˆImage.gz-dtbæˆ–Imageï¼‰
      - name: Extract Kernel Image
        run: |
          cd $KDIR
          OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          mkdir -p $OUTPUT_DIR
          
          # ä¼˜å…ˆæ‰¾GKIæ ¼å¼çš„Image.gz-dtbï¼Œå…¶æ¬¡æ‰¾Image
          if [ -f arch/arm64/boot/Image.gz-dtb ]; then
            cp arch/arm64/boot/Image.gz-dtb $OUTPUT_DIR/kernel.img
            echo "âœ… Found Image.gz-dtb (GKI format)"
          elif [ -f arch/arm64/boot/Image ]; then
            cp arch/arm64/boot/Image $OUTPUT_DIR/kernel.img
            echo "âœ… Found Image (non-GKI format)"
          else
            echo "âŒ ERROR: Kernel image not found in $KDIR/arch/arm64/boot/!"
            exit 1
          fi

      # 9. ç”ŸæˆAnyKernel3åˆ·æœºåŒ…ï¼ˆä½¿ç”¨SukiSU_patchä»“åº“çš„AnyKernel3æ¨¡æ¿ï¼Œæˆ–æ‰‹åŠ¨åˆ›å»ºï¼‰
      - name: Generate AnyKernel3 Flashable ZIP
        run: |
          # æ–¹æ¡ˆ1ï¼šä½¿ç”¨SukiSU_patchä»“åº“çš„AnyKernel3æ¨¡æ¿ï¼ˆè‹¥ä»“åº“æœ‰æ­¤ç›®å½•ï¼‰
          PATCH_ANYKERNEL_DIR="../patches/AnyKernel3"  # è¡¥ä¸ä»“åº“ä¸­çš„AnyKernel3ç›®å½•
          if [ -d "$PATCH_ANYKERNEL_DIR" ]; then
            echo "âœ… Using AnyKernel3 template from SukiSU_patch repo"
            cp -r "$PATCH_ANYKERNEL_DIR" anykernel3  # å¤åˆ¶åˆ°å·¥ä½œæµç›®å½•
          else
            # æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨å…‹éš†AnyKernel3æ¨¡æ¿ï¼ˆå¤‡ç”¨ï¼‰
            echo "âš ï¸ SukiSU_patch AnyKernel3 not found, cloning default template"
            git clone https://ghproxy.com/https://github.com/osm0sis/AnyKernel3.git anykernel3 --depth=1
          fi
          
          # å¤åˆ¶å†…æ ¸é•œåƒåˆ°AnyKernel3ç›®å½•
          cp $GITHUB_WORKSPACE/output/kernel.img anykernel3/
          
          # ä¿®æ”¹AnyKernel3è®¾å¤‡ä¿¡æ¯ï¼ˆé€‚é…pissarroï¼‰
          cat > anykernel3/anykernel.sh << 'EOF'
          # AnyKernel3 for Pissarro (Redmi Note 11 Pro) - SukiSU Ultra 4.14
          kernel.string=SukiSU Ultra 4.14 for Pissarro
          kernel.version=SukiSU-Ultra-4.14-$(date +%Y%m%d)
          device.name1=pissarro
          device.name2=21091116C
          device.name3=Redmi Note 11 Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          block=/dev/block/bootdevice/by-name/boot
          supported.versions=13-15  # æ”¯æŒAndroid 13-15
          EOF
          
          # æ‰“åŒ…ä¸ºåˆ·æœºZIP
          cd anykernel3
          zip -r9 ../SukiSU-Ultra-4.14-pissarro-anykernel3.zip ./* -x ".git/*" "README.md"
          cd ..
          echo "âœ… Generated AnyKernel3 ZIP: SukiSU-Ultra-4.14-pissarro-anykernel3.zip"

      # 10. ä¸Šä¼ æœ€ç»ˆåˆ·æœºåŒ…ï¼ˆä¾›ä¸‹è½½ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-4.14-pissarro-anykernel3  # äº§ç‰©åå«å†…æ ¸ç‰ˆæœ¬
          path: SukiSU-Ultra-4.14-pissarro-anykernel3.zip  # åˆ·æœºåŒ…è·¯å¾„
