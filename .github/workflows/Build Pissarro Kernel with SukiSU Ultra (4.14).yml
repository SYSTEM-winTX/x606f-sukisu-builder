name: Build Pissarro Kernel with SukiSU Ultra (4.14)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå·¥ä½œæµæ‰€åœ¨ä»“åº“ï¼‰
      - name: Checkout Current Repository
        uses: actions/checkout@v4

      # 2. ã€è·¯å¾„æ›´æ–°ã€‘å…‹éš†ç›®æ ‡å†…æ ¸æºç ä»“åº“ï¼ˆhttps://github.com/MiCode/Xiaomi_Kernel_OpenSource/tree/pissarro-r-ossï¼‰åˆ°kernel-sourceç›®å½•
      - name: Checkout Kernel Source from Target Repository
        uses: actions/checkout@v4
        with:
          repository: MiCode/Xiaomi_Kernel_OpenSource  # æ–°ä»“åº“è·¯å¾„
          path: kernel-source           # å…‹éš†åˆ°kernel-sourceç›®å½•
          ref: pissarro-r-oss          # åˆ†æ”¯åï¼ˆæ ¹æ®å®é™…è°ƒæ•´ï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}  # è®¿é—®ä»¤ç‰Œï¼ˆå…¬å¼€ä»“åº“å¯çœç•¥ï¼‰

      # 3. è®¾ç½®æ„å»ºç¯å¢ƒï¼ˆå®‰è£…ä¾èµ–ï¼‰
      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make automake \
            autogen autoconf pkg-config git wget tar xz-utils gcc g++ \
            build-essential ccache curl python3 python3-pip unzip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu patch libelf-dev libncurses5-dev
          echo "âœ… Build environment ready"

      # 4. ã€ç»ˆæä¿®æ­£ã€‘åº”ç”¨SukiSU_patchä»“åº“çš„4.14å†…æ ¸è¡¥ä¸ï¼ˆå…¨è‡ªåŠ¨å†²çªä¿®å¤ï¼‰
      - name: Apply SukiSU Patch (4.14 Kernel)
        run: |
          set -x  # å¼€å¯è°ƒè¯•æ¨¡å¼

          # --------------------------
          # 1. å…‹éš†SukiSU_patchä»“åº“ï¼ˆå¼ºåˆ¶æ¸…ç†æ®‹ç•™ï¼‰
          # --------------------------
          PATCH_REPO_URL="https://github.com/SukiSU-Ultra/SukiSU_patch.git"
          PATCH_DIR="patches"
          rm -rf "$PATCH_DIR"
          git clone --depth=1 "$PATCH_REPO_URL" "$PATCH_DIR" || { 
            echo "âŒ å…‹éš†å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œæˆ–ä»“åº“å¯ç”¨æ€§"
            exit 1
          }

          # --------------------------
          # 2. éªŒè¯è¡¥ä¸æ–‡ä»¶å­˜åœ¨ï¼ˆå…³é”®ä¿®æ­£ï¼ï¼‰
          # --------------------------
          PATCH_FILE="ksu_hooks_4.14.patch"  # ç›´æ¥ä½äºä»“åº“æ ¹ç›®å½•
          if [ ! -f "$PATCH_DIR/$PATCH_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šè¡¥ä¸æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            ls -la "$PATCH_DIR"  # åˆ—å‡ºä»“åº“å®é™…æ–‡ä»¶
            exit 1
          fi

          # --------------------------
          # 3. è¿›å…¥å†…æ ¸æºç ç›®å½•
          # --------------------------
          cd kernel-source || { 
            echo "âŒ é”™è¯¯ï¼škernel-sourceç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          }

          # --------------------------
          # 4. åº”ç”¨è¡¥ä¸ï¼ˆå…¨è‡ªåŠ¨å†²çªä¿®å¤ï¼‰
          # --------------------------
          echo "ğŸ”§ å¼€å§‹åº”ç”¨è¡¥ä¸..."
          if ! git apply --whitespace=fix "$PATCH_DIR/$PATCH_FILE"; then
            echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
            
            # è‡ªåŠ¨ç”Ÿæˆå†²çªæ ‡è®°æ–‡ä»¶ï¼ˆ.rejï¼‰
            git apply --reject "$PATCH_DIR/$PATCH_FILE"
            
            # æŸ¥æ‰¾æ‰€æœ‰.rejæ–‡ä»¶å¹¶è¾“å‡ºå†²çªä½ç½®
            REJ_FILES=$(find . -name "*.rej")
            if [ -n "$REJ_FILES" ]; then
              echo "ğŸ” å‘ç°å†²çªæ–‡ä»¶ï¼š"
              echo "$REJ_FILES"
              
              # ç»Ÿè®¡å†²çªæ•°é‡
              CONFLICT_COUNT=$(grep -c "<<<<<<<" $REJ_FILES)
              echo "âš ï¸ å…±å‘ç° $CONFLICT_COUNT å¤„å†²çª"
              
              # è‡ªåŠ¨å°è¯•ä¿®å¤ç®€å•å†²çªï¼ˆä¿ç•™è¡¥ä¸å†…å®¹ï¼‰
              for rej_file in $REJ_FILES; do
                PATCH_FILE_CLEAN=$(dirname $rej_file)/$(basename $rej_file .rej).patch
                if [ -f "$PATCH_FILE_CLEAN" ]; then
                  echo "ğŸ› ï¸ ä¿®å¤å†²çªï¼š$PATCH_FILE_CLEAN"
                  sed -i '/^<<<<<<< /d' "$PATCH_FILE_CLEAN"
                  sed -i '/^=======$/d' "$PATCH_FILE_CLEAN"
                  sed -i '/^>>>>>>> /d' "$PATCH_FILE_CLEAN"
                  git apply --whitespace=fix "$PATCH_FILE_CLEAN"
                fi
              done
            
              # å†æ¬¡å°è¯•åº”ç”¨è¡¥ä¸
              if git apply --whitespace=fix "$PATCH_DIR/$PATCH_FILE"; then
                echo "âœ… è¡¥ä¸ä¿®å¤æˆåŠŸï¼"
              else
                echo "âŒ å†²çªä»å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨è§£å†³ï¼š"
                exit 1
              fi
            else
              echo "âŒ æœªçŸ¥é”™è¯¯ï¼Œæ— æ³•æ£€æµ‹å†²çªæ–‡ä»¶"
              exit 1
            fi
          else
            echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸï¼"
          fi

          # --------------------------
          # 5. æ¸…ç†æ®‹ç•™æ–‡ä»¶
          # --------------------------
          find . -name "*.rej" -exec rm {} \;  # åˆ é™¤å†²çªæ ‡è®°æ–‡ä»¶

      # 5. è®¾ç½®å†…æ ¸æ ¹ç›®å½•ï¼ˆKDIRï¼‰ä¸ºç›®æ ‡ä»“åº“ï¼ˆkernel-sourceï¼‰
      - name: Set Kernel Root Directory (KDIR)
        id: set-kdir
        run: |
          KDIR="$GITHUB_WORKSPACE/kernel-source"  # å†…æ ¸æºç è·¯å¾„
          if [ ! -d "$KDIR/arch" ]; then
            echo "âŒ ERROR: $KDIR/arch not found! ç¡®ä¿ç›®æ ‡ä»“åº“åŒ…å«å®Œæ•´å†…æ ¸æºç "
            exit 1
          fi
          echo "âœ… Kernel root directory (KDIR): $KDIR"
          echo "KDIR=$KDIR" >> $GITHUB_ENV

      # 6. æŸ¥æ‰¾pissarroè®¾å¤‡çš„defconfigï¼ˆçº¢ç±³Note 11 Proï¼‰
      - name: Detect Pissarro Defconfig
        id: detect-defconfig
        run: |
          cd $KDIR
          DEFCONFIG=$(find arch/arm64/configs -type f -name "*pissarro*_defconfig" | head -n 1 | xargs basename)
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG=$(find arch/arm64/configs -type f \( -name "*umi*_defconfig" -o -name "*redmi*note*11*pro*_defconfig" \) | head -n 1 | xargs basename)
          fi
          if [ -z "$DEFCONFIG" ] || [ ! -f "arch/arm64/configs/$DEFCONFIG" ]; then
            echo "âŒ ERROR: No valid defconfig found for pissarro!"
            exit 1
          fi
          echo "âœ… Found defconfig: $DEFCONFIG"
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

      # 7. ç¼–è¯‘å†…æ ¸ï¼ˆARM64æ¶æ„ï¼Œäº¤å‰ç¼–è¯‘ï¼‰
      - name: Build Kernel (4.14)
        run: |
          cd $KDIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          make $DEFCONFIG
          find drivers -name "modules.builtin" -exec rm {} \; || true
          find drivers -type d -exec touch {}/modules.builtin \; || true
          
          if ! make -j$(nproc); then
            echo "âš ï¸ Parallel build failed, retrying in single-thread mode"
            make
          fi
          echo "âœ… Kernel compiled successfully!"

      # 8. æå–å†…æ ¸é•œåƒ
      - name: Extract Kernel Image
        run: |
          cd $KDIR
          OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          mkdir -p $OUTPUT_DIR
          cp arch/arm64/boot/Image.gz-dtb $OUTPUT_DIR/kernel.img

      # 9. ç”ŸæˆAnyKernel3åˆ·æœºåŒ…
      - name: Generate AnyKernel3 Flashable ZIP
        run: |
          PATCH_ANYKERNEL_DIR="../patches/AnyKernel3"
          if [ -d "$PATCH_ANYKERNEL_DIR" ]; then
            cp -r "$PATCH_ANYKERNEL_DIR" anykernel3
          else
            git clone https://ghproxy.com/https://github.com/osm0sis/AnyKernel3.git anykernel3 --depth=1
          fi
          cp $GITHUB_WORKSPACE/output/kernel.img anykernel3/
          
          cat > anykernel3/anykernel.sh << 'EOF'
          # AnyKernel3 for Pissarro (Redmi Note 11 Pro) - SukiSU Ultra 4.14
          kernel.string=SukiSU Ultra 4.14 for Pissarro
          kernel.version=SukiSU-Ultra-4.14-$(date +%Y%m%d)
          device.name1=pissarro
          device.name2=21091116C
          device.name3=Redmi Note 11 Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          block=/dev/block/bootdevice/by-name/boot
          supported.versions=13-15
          EOF
          
          cd anykernel3
          zip -r9 ../SukiSU-Ultra-4.14-pissarro-anykernel3.zip ./* -x ".git/*" "README.md" "LICENSE"
          cd ..

      # 10. ä¸Šä¼ åˆ·æœºåŒ…
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-4.14-pissarro-anykernel3
          path: SukiSU-Ultra-4.14-pissarro-anykernel3.zip
