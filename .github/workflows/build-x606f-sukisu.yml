name: Build Pissarro Kernel with SukiSU Ultra

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå·¥ä½œæµæ‰€åœ¨ä»“åº“ï¼‰
      - name: Checkout Current Repository
        uses: actions/checkout@v4
      
      # 2. å…‹éš†ä½ çš„ç›®æ ‡ä»“åº“ï¼ˆhttps://github.com/SYSTEM-winTX/000ï¼‰ä½œä¸ºå†…æ ¸æºç 
      - name: Checkout Kernel Source from Target Repository
        uses: actions/checkout@v4
        with:
          repository: SYSTEM-winTX/000  # ä½ çš„ç›®æ ‡ä»“åº“
          path: kernel-source           # å…‹éš†åˆ°kernel-sourceç›®å½•
          ref: main                    # åˆ†æ”¯åï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨GitHubè‡ªåŠ¨ç”Ÿæˆçš„token

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex libssl-dev make automake \
            autogen autoconf pkg-config git wget tar xz-utils gcc g++ \
            build-essential ccache curl python3 python3-pip unzip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu patch libelf-dev libncurses5-dev
          echo "âœ… Build environment ready"

      # 3. åº”ç”¨SukiSU Ultraè¡¥ä¸åˆ°ç›®æ ‡ä»“åº“ï¼ˆkernel-sourceç›®å½•ï¼‰
      - name: Apply SukiSU Ultra Patches
        run: |
          # å…‹éš†SukiSU Ultraè¡¥ä¸ä»“åº“
          git clone https://ghproxy.com/https://github.com/SukiSU/SukiSU-Ultra-Patches.git patches --depth=1
          
          # è¿›å…¥å†…æ ¸æºç ç›®å½•ï¼ˆä½ çš„ç›®æ ‡ä»“åº“ï¼‰
          cd kernel-source
          
          # åº”ç”¨è¡¥ä¸
          if [ -f ../patches/sukisu-ultra.patch ]; then
            git apply ../patches/sukisu-ultra.patch
            echo "âœ… Applied SukiSU Ultra patch to target repository"
          else
            echo "âš ï¸ Warning: sukisu-ultra.patch not found, skipping patch"
          fi

      # 4. è®¾ç½®å†…æ ¸æ ¹ç›®å½•ä¸ºä½ çš„ç›®æ ‡ä»“åº“ï¼ˆkernel-sourceï¼‰
      - name: Set Kernel Root Directory (KDIR)
        id: set-kdir
        run: |
          KDIR="$GITHUB_WORKSPACE/kernel-source"
          if [ ! -d "$KDIR/arch" ]; then
            echo "âŒ ERROR: $KDIR/arch not found! Ensure target repository contains arch/"
            exit 1
          fi
          echo "âœ… Kernel root directory (KDIR): $KDIR"
          echo "KDIR=$KDIR" >> $GITHUB_ENV

      # 5. æŸ¥æ‰¾pissarroè®¾å¤‡çš„defconfig
      - name: Detect Pissarro Defconfig
        id: detect-defconfig
        run: |
          cd $KDIR
          DEFCONFIG=$(find arch/arm64/configs -type f -name "*pissarro*_defconfig" | head -n 1 | xargs basename)
          
          if [ -z "$DEFCONFIG" ]; then
            DEFCONFIG=$(find arch/arm64/configs -type f \( -name "*umi*_defconfig" -o -name "*redmi*note*11*pro*_defconfig" \) | head -n 1 | xargs basename)
          fi
          
          if [ -z "$DEFCONFIG" ] || [ ! -f "arch/arm64/configs/$DEFCONFIG" ]; then
            echo "âŒ ERROR: No valid defconfig found!"
            echo "Available defconfigs:"
            ls -la arch/arm64/configs/ | grep "_defconfig"
            exit 1
          fi
          
          echo "âœ… Found defconfig: $DEFCONFIG"
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

      # 6. ç¼–è¯‘å†…æ ¸
      - name: Build Kernel
        run: |
          cd $KDIR
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          echo "ğŸ”¨ Running make $DEFCONFIG"
          make $DEFCONFIG
          
          find drivers -name "modules.builtin" -exec rm {} \; || true
          find drivers -type d -exec touch {}/modules.builtin \; || true
          
          echo "ğŸ”¨ Building kernel with $(nproc) threads..."
          if ! make -j$(nproc); then
            echo "âš ï¸ Parallel build failed, retrying in single-thread mode"
            make
          fi
          echo "âœ… Kernel compiled successfully!"

      # 7. æå–å†…æ ¸é•œåƒ
      - name: Extract Kernel Image
        run: |
          cd $KDIR
          OUTPUT_DIR="$GITHUB_WORKSPACE/output"
          mkdir -p $OUTPUT_DIR
          
          if [ -f arch/arm64/boot/Image.gz-dtb ]; then
            cp arch/arm64/boot/Image.gz-dtb $OUTPUT_DIR/kernel.img
          elif [ -f arch/arm64/boot/Image ]; then
            cp arch/arm64/boot/Image $OUTPUT_DIR/kernel.img
          else
            echo "âŒ ERROR: Kernel image not found!"
            exit 1
          fi
          echo "âœ… Kernel image copied to $OUTPUT_DIR"

      # 8. ç”ŸæˆAnyKernel3åˆ·æœºåŒ…
      - name: Generate AnyKernel3 Flashable ZIP
        run: |
          git clone https://ghproxy.com/https://github.com/osm0sis/AnyKernel3.git anykernel3 --depth=1
          cp $GITHUB_WORKSPACE/output/kernel.img anykernel3/
          
          cat > anykernel3/anykernel.sh << 'EOF'
          # AnyKernel3 for Pissarro (Redmi Note 11 Pro)
          kernel.string=SukiSU Ultra for Pissarro
          kernel.version=SukiSU-Ultra-$(date +%Y%m%d)
          device.name1=pissarro
          device.name2=21091116C
          device.name3=Redmi Note 11 Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          block=/dev/block/bootdevice/by-name/boot
          supported.versions=13-15
          EOF
          
          cd anykernel3
          zip -r9 ../SukiSU-Ultra-pissarro-anykernel3.zip ./* -x ".git/*" "README.md"
          cd ..
          echo "âœ… Generated AnyKernel3 ZIP"

      # 9. ä¸Šä¼ æœ€ç»ˆåˆ·æœºåŒ…
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-pissarro-anykernel3
          path: SukiSU-Ultra-pissarro-anykernel3.zip
